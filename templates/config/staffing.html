{% load dict_extras %}


<!DOCTYPE html>
<html>
<head>
    <title>Staffing Configuration</title>
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }

    h2 {
        margin-bottom: 5px;
    }

    .page-layout {
        display: flex;
        gap: 30px;
        align-items: flex-start;
    }

    /* LEFT */
    .grid-container {
        flex: 3;
        overflow-x: auto;
    }

    table {
        border-collapse: collapse;
        user-select: none;
    }

    th, td {
        border: 1px solid #aaa;
        width: 42px;
        height: 28px;
        text-align: center;
    }

    th {
        background: #f0f0f0;
        font-weight: bold;
    }

    td.closed-hour {
        background: #e0e0e0;
        color: #999;
    }

    td.open-hour {
        background: #cce5ff;   /* 1 worker */
        cursor: pointer;
        font-weight: bold;
    }

    td.multi-worker {
        background: #66b3ff;   /* >1 workers */
        color: #000;
    }

    td.active {
        background: #66b3ff;
        color: #000;
    }

    /* RIGHT */
    .controls-container {
        flex: 1;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fafafa;
    }

    .control-group {
        margin-bottom: 20px;
    }

    .control-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .control-group span {
        margin-left: 10px;
        font-weight: bold;
    }

    .save-btn {
        width: 100%;
        padding: 10px;
        font-size: 15px;
        font-weight: bold;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .save-btn:hover {
        background: #0056b3;
    }
    </style>

</head>
<body>

<h2>Bar Staffing Configuration</h2>
<p>Click & drag to activate hours. Click a cell to change workers.</p>

<div class="page-layout">

    <!-- LEFT SIDE: TABLE -->
    <div class="grid-container">
        <table id="grid">
            <tr>
                <th>Hour</th>
                {% for day in day_names %}
                    <th>{{ day }}</th>
                {% endfor %}
            </tr>

            {% for hour in hours %}
            <tr>
                <th>{{ hour }}</th>

                {% for day in days %}
                    {% with workers=saved|get_item:day|get_item:hour %}
                        {% if hour < opening_hour or hour >= closing_hour %}
                            <td class="closed-hour">–</td>
                        {% else %}
                            <td class="open-hour {% if workers|default:1 > 1 %}multi-worker{% endif %}"
                                data-day="{{ day }}"
                                data-hour="{{ hour }}"
                                data-workers="{{ workers|default:1 }}">
                                {{ workers|default:1 }}
                            </td>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- RIGHT SIDE: CONTROLS -->
    <div class="controls-container">

        <h3>Bar Configuration</h3>

        <div class="control-group">
            <label>Opening Hour</label>
            <input type="range" id="openingHour" min="0" max="23" value="{{ opening_hour }}">
            <span id="openingHourValue">{{ opening_hour }}</span>
        </div>

        <div class="control-group">
            <label>Closing Hour</label>
            <input type="range" id="closingHour" min="1" max="24" value="{{ closing_hour }}">
            <span id="closingHourValue">{{ closing_hour }}</span>
        </div>

        <div class="control-group">
            <label>Max Workers per Hour</label>
            <input type="range" id="maxWorkers" min="1" max="10" value="{{ max_workers }}">
            <span id="maxWorkersValue">{{ max_workers }}</span>
        </div>

        <button class="save-btn" onclick="saveConfig()">Save Configuration</button>
    </div>

</div>


<script>
/* -------------------------------
   GLOBAL STATE
-------------------------------- */
let maxWorkers = parseInt(document.getElementById("maxWorkers").value);

/* -------------------------------
   SLIDER VALUE DISPLAY
-------------------------------- */
function updateSliderValue(id) {
    document.getElementById(id + "Value").textContent =
        document.getElementById(id).value;
}

["openingHour", "closingHour", "maxWorkers"].forEach(id => {
    const input = document.getElementById(id);

    updateSliderValue(id);

    input.addEventListener("input", () => {
        updateSliderValue(id);

        if (id === "maxWorkers") {
            maxWorkers = parseInt(input.value);
        }
    });
});

/* -------------------------------
   GRID CELL CLICK LOGIC
   - Clicking cycles worker count
   - Color reflects worker count
-------------------------------- */
document.querySelectorAll(".open-hour").forEach(cell => {

    cell.addEventListener("click", () => {
        let workers = parseInt(cell.dataset.workers || 1);

        // Cycle workers: 1 → maxWorkers → 1
        workers = workers % maxWorkers + 1;

        cell.dataset.workers = workers;
        cell.textContent = workers;

        // Color logic
        if (workers > 1) {
            cell.classList.add("multi-worker");
        } else {
            cell.classList.remove("multi-worker");
        }
    });

});

/* -------------------------------
   SAVE CONFIGURATION
-------------------------------- */
function saveConfig() {
    let cells = [];

    document.querySelectorAll(".open-hour").forEach(cell => {
        cells.push({
            day: parseInt(cell.dataset.day),
            hour: parseInt(cell.dataset.hour),
            workers: parseInt(cell.dataset.workers)
        });
    });

    fetch("", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            opening_hour: parseInt(document.getElementById("openingHour").value),
            closing_hour: parseInt(document.getElementById("closingHour").value),
            max_workers: parseInt(document.getElementById("maxWorkers").value),
            cells: cells
        })
    })
    .then(response => {
        if (!response.ok) throw new Error("Save failed");
        alert("Configuration saved successfully");
    })
    .catch(err => {
        alert("Error saving configuration");
        console.error(err);
    });
}
</script>




</body>
</html>
